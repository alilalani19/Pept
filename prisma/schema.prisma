// Prisma Schema for Pept
// -------------------------------------------------

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// --------------- Enums ---------------

enum EvidenceLevel {
  IN_VITRO
  ANIMAL
  LIMITED_HUMAN
  CLINICAL
  MIXED
}

enum LegalStatusBadge {
  RESEARCH_ONLY
  PRESCRIPTION
  REGULATED
  BANNED_SPORT
  UNREGULATED
}

enum UserRole {
  USER
  ADMIN
}

enum MessageRole {
  USER
  ASSISTANT
  SYSTEM
}

// --------------- NextAuth Models ---------------

model User {
  id            String        @id @default(cuid())
  name          String?
  email         String?       @unique
  emailVerified DateTime?
  image         String?
  password      String?
  role          UserRole      @default(USER)
  accounts      Account[]
  sessions      Session[]
  favorites        Favorite[]
  chatSessions     ChatSession[]
  emailSignInAlert Boolean       @default(true)
  emailNewPeptide  Boolean       @default(true)
  emailNewsletter  Boolean       @default(false)
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt

  @@map("users")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// --------------- Core Domain Models ---------------

model Peptide {
  id                 String             @id @default(cuid())
  name               String
  slug               String             @unique
  aliases            String[]
  summary            String?
  description        String?            @db.Text
  sequence           String?
  molecularWeight    Float?
  mechanismOfAction  String?            @db.Text
  biologicalPathways String[]
  researchFindings   String?            @db.Text
  evidenceLevel      EvidenceLevel?
  risks              String?            @db.Text
  legalStatus        String?            @db.Text
  legalStatusBadge   LegalStatusBadge?
  disclaimer         String?            @db.Text
  published          Boolean            @default(false)
  metaTitle          String?
  metaDescription    String?
  categories         PeptideCategory[]
  suppliers          PeptideSupplier[]
  favorites          Favorite[]
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt

  @@index([slug])
  @@index([published])
  @@map("peptides")
}

model Category {
  id          String            @id @default(cuid())
  name        String
  slug        String            @unique
  description String?
  image       String?
  peptides    PeptideCategory[]
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  @@index([slug])
  @@map("categories")
}

model PeptideCategory {
  id         String   @id @default(cuid())
  peptideId  String
  categoryId String

  peptide  Peptide  @relation(fields: [peptideId], references: [id], onDelete: Cascade)
  category Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@unique([peptideId, categoryId])
  @@index([peptideId])
  @@index([categoryId])
  @@map("peptide_categories")
}

model Supplier {
  id                String            @id @default(cuid())
  name              String
  slug              String            @unique
  description       String?
  website           String?
  affiliateBaseUrl  String?
  affiliateCode     String?
  coaAvailable      Boolean           @default(false)
  coaUrl            String?
  thirdPartyTested  Boolean           @default(false)
  transparencyScore Int               @default(0)
  published         Boolean           @default(false)
  peptides          PeptideSupplier[]
  clicks            AffiliateClick[]
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  @@index([slug])
  @@index([published])
  @@map("suppliers")
}

model PeptideSupplier {
  id         String  @id @default(cuid())
  peptideId  String
  supplierId String
  productUrl String?
  price      Float?

  peptide  Peptide  @relation(fields: [peptideId], references: [id], onDelete: Cascade)
  supplier Supplier @relation(fields: [supplierId], references: [id], onDelete: Cascade)

  @@unique([peptideId, supplierId])
  @@index([peptideId])
  @@index([supplierId])
  @@map("peptide_suppliers")
}

model AffiliateClick {
  id         String   @id @default(cuid())
  supplierId String
  peptideId  String?
  userId     String?
  ipHash     String?
  userAgent  String?
  referrer   String?
  createdAt  DateTime @default(now())

  supplier Supplier @relation(fields: [supplierId], references: [id], onDelete: Cascade)

  @@index([supplierId])
  @@index([peptideId])
  @@index([userId])
  @@index([createdAt])
  @@map("affiliate_clicks")
}

model Favorite {
  id        String   @id @default(cuid())
  userId    String
  peptideId String
  createdAt DateTime @default(now())

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  peptide Peptide @relation(fields: [peptideId], references: [id], onDelete: Cascade)

  @@unique([userId, peptideId])
  @@index([userId])
  @@index([peptideId])
  @@map("favorites")
}

// --------------- Chat Models ---------------

model ChatSession {
  id        String        @id @default(cuid())
  userId    String
  title     String?
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
  messages  ChatMessage[]

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("chat_sessions")
}

model ChatMessage {
  id        String      @id @default(cuid())
  sessionId String
  role      MessageRole
  content   String      @db.Text
  createdAt DateTime    @default(now())

  session ChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@map("chat_messages")
}

// --------------- Newsletter ---------------

model NewsletterSubscriber {
  id        String   @id @default(cuid())
  email     String   @unique
  active    Boolean  @default(true)
  createdAt DateTime @default(now())

  @@map("newsletter_subscribers")
}
